[tox]
envlist = py{27,35,36,37,38,39}, pypy{,3}, mypy

[testenv]
deps=
    -r requirements.test.txt
    -r requirements.txt
    coverage
    codecov
    pytest-cov

[testenv:travis]
passenv=
    TOXENV
    CI
    TRAVIS
    TRAVIS_*

[testenv:appveyor]
passenv=
    TOXENV
    CI
    APPVEYOR
    APPVEYOR_*

commands=
    python -c 'import sys; print(sys.version)'
    pytest -s --basetemp={envtmpdir} canmatrix --cov-config={toxinidir}/.coveragerc --cov=canmatrix --pyargs {posargs}
    coverage report

[testenv:dist]
envdir={toxworkdir}/{envname}_env
commands=
    python -c 'import sys; print(sys.version)'
    python setup.py sdist --formats=gztar,zip --dist-dir={toxinidir}/dist
    python setup.py bdist_wheel --universal --dist-dir={toxinidir}/dist

[testenv:codecov]
deps=
    codecov==2.0.15
commands=
    codecov

[testenv:old_tests]
commands=
    ./test.sh

[testenv:mypy]
description = type check
basepython = python3.6
deps=
    mypy
commands=
    python -m mypy src --config-file mypy.ini

[coverage:run]
# we could also use branch coverage
branch = False

[coverage:report]
# two digits after decimal point
precision = 3
show_missing = True
exclude_lines =
    # Have to re-enable the standard pragma, see https://coverage.readthedocs.io/en/coverage-4.5.1a/config.html#syntax
    pragma: no cover

    # Don't complain if non-runnable code isn't run:
    if __name__ == .__main__.:

    # Don't complain if tests don't hit defensive assertion code:
    raise NotImplementedError
